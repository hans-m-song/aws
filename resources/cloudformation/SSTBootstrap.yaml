Parameters:
  Qualifier:
    Type: String
    Default: hnb659fds
  BootstrapVersion:
    Type: AWS::SSM::Parameter::Value<String>
    Default: '/cdk-bootstrap/hnb659fds/version'
    Description:
      Version of the CDK Bootstrap resources in this environment, automatically
      retrieved from SSM Parameter Store. [cdk:skip]

Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: 'true'
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: Bucket
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsRole
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - Bucket
                  - Arn
              - Fn::Join:
                  - ''
                  - - Fn::GetAtt:
                        - Bucket
                        - Arn
                    - '/*'
        Version: '2012-10-17'
    Metadata:

  CustomS3AutoDeleteObjects:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsHandler
          - Arn
      BucketName:
        Ref: Bucket
    DependsOn:
      - BucketPolicy
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:

  CustomS3AutoDeleteObjectsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      ManagedPolicyArns:
        - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:

  CustomS3AutoDeleteObjectsHandler:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: cdk-hnb659fds-assets-255851393769-us-east-1
        S3Key: e57c1acaa363d7d2b81736776007a7091bc73dff4aeb8135627c4511a51e7dca.zip
      Timeout: 900
      MemorySize: 128
      Handler: __entrypoint__.handler
      Role:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsRole
          - Arn
      Runtime: nodejs14.x
      Description:
        Fn::Join:
          - ''
          - - 'Lambda function for auto-deleting objects in '
            - Ref: Bucket
            - ' S3 bucket.'
    DependsOn:
      - CustomS3AutoDeleteObjectsRole
    Metadata:
      aws:asset:path: asset.e57c1acaa363d7d2b81736776007a7091bc73dff4aeb8135627c4511a51e7dca
      aws:asset:property: Code
  SSTBootstrapVersion:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value: '3'
      Description: SST Bootstrap Stack /sst/bootstrap/version
      Name: '/sst/bootstrap/version'
      Tier: Standard
    Metadata:

  SSTBootstrapParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value: SSTBootstrap
      Description: SST Bootstrap Stack /sst/bootstrap/stack-name
      Name: '/sst/bootstrap/stack-name'
      Tier: Standard
    Metadata:

  SSTBootstrapBucketName:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Ref: Bucket
      Description: SST Bootstrap Stack /sst/bootstrap/bucket-name
      Name: '/sst/bootstrap/bucket-name'
      Tier: Standard
    Metadata:

Rules:
  CheckBootstrapVersion:
    Assertions:
      - Assert:
          Fn::Not:
            - Fn::Contains:
                - - '1'
                  - '2'
                  - '3'
                  - '4'
                  - '5'
                - Ref: BootstrapVersion
        AssertDescription:
          CDK bootstrap stack version 6 required. Please run 'cdk bootstrap'
          with a recent version of the CDK CLI.
